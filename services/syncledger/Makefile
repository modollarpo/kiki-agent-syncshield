# SyncLedgerâ„¢ Makefile - Build automation for OaaS Auditor

.PHONY: help build run test proto docker clean

# Default target
help:
	@echo "SyncLedgerâ„¢ - Automated OaaS Auditor"
	@echo ""
	@echo "Available targets:"
	@echo "  make build       - Build the Go binary"
	@echo "  make run         - Run the service locally"
	@echo "  make test        - Run unit tests"
	@echo "  make proto       - Generate gRPC code from protobuf"
	@echo "  make docker      - Build Docker image"
	@echo "  make clean       - Remove build artifacts"
	@echo "  make lint        - Run code linters"
	@echo "  make migrate     - Run database migrations"

# Build the binary
build:
	@echo "ğŸ”¨ Building SyncLedgerâ„¢..."
	go build -o bin/syncledger main.go
	@echo "âœ… Build complete: bin/syncledger"

# Run locally (requires PostgreSQL running)
run:
	@echo "ğŸš€ Starting SyncLedgerâ„¢..."
	@echo "gRPC: localhost:50053"
	@echo "HTTP: localhost:8090"
	go run main.go

# Run tests with coverage
test:
	@echo "ğŸ§ª Running tests..."
	go test -v -race -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report: coverage.html"

# Generate protobuf/gRPC code
proto:
	@echo "ğŸ”§ Generating gRPC code from protobuf..."
	mkdir -p proto
	protoc --go_out=proto --go_opt=paths=source_relative \
		--go-grpc_out=proto --go-grpc_opt=paths=source_relative \
		../../schemas/cms_integration.proto
	@echo "âœ… Protobuf files generated in proto/"

# Build Docker image
docker:
	@echo "ğŸ³ Building Docker image..."
	docker build -t kiki/syncledger:latest .
	@echo "âœ… Image: kiki/syncledger:latest"

# Run Docker container
docker-run:
	@echo "ğŸš€ Running SyncLedgerâ„¢ in Docker..."
	docker run -d \
		--name syncledger \
		-p 50053:50053 \
		-p 8090:8090 \
		-e DATABASE_URL=postgres://kiki:password@host.docker.internal:5432/kiki_ledger \
		kiki/syncledger:latest

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -f bin/syncledger
	rm -f coverage.out coverage.html
	rm -rf proto/
	@echo "âœ… Clean complete"

# Run code linters
lint:
	@echo "ğŸ” Running linters..."
	golangci-lint run
	@echo "âœ… Lint complete"

# Database migrations (requires golang-migrate)
migrate:
	@echo "ğŸ—„ï¸  Running database migrations..."
	migrate -path db/migrations -database "${DATABASE_URL}" up
	@echo "âœ… Migrations complete"

# Download dependencies
deps:
	@echo "ğŸ“¦ Downloading dependencies..."
	go mod download
	go mod tidy
	@echo "âœ… Dependencies updated"

# Run service with live reload (requires air)
dev:
	@echo "ğŸ”¥ Starting development server with hot reload..."
	air

# gRPC testing with grpcurl
grpc-test:
	@echo "ğŸ§ª Testing gRPC endpoints..."
	grpcurl -plaintext localhost:50053 list
	grpcurl -plaintext localhost:50053 grpc.health.v1.Health/Check

# Health check
health:
	@echo "ğŸ’š Checking service health..."
	curl -s http://localhost:8090/healthz | jq .

# Prometheus metrics
metrics:
	@echo "ğŸ“Š Fetching Prometheus metrics..."
	curl -s http://localhost:8090/metrics | grep syncledger

# Format code
fmt:
	@echo "âœ¨ Formatting code..."
	go fmt ./...
	@echo "âœ… Format complete"

# Run all CI checks (lint, test, build)
ci: lint test build
	@echo "âœ… All CI checks passed"
